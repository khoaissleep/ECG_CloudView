<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AD8232 ECG Monitor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --primary: #3498db;
      --secondary: #2c3e50;
      --success: #2ecc71;
      --danger: #e74c3c;
      --warning: #f39c12;
      --light: #ecf0f1;
      --dark: #34495e;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e1e1e1;
    }
    
    .dashboard-title {
      color: var(--secondary);
      font-size: 1.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .dashboard-title svg {
      margin-right: 10px;
      color: var(--danger);
    }
    
    .sensor-info {
      font-size: 0.9rem;
      color: #666;
      margin-left: 30px;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      font-weight: 500;
    }
    
    .status-dot {
      height: 12px;
      width: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-online {
      background-color: var(--success);
    }
    
    .status-offline {
      background-color: var(--danger);
    }
    
    .datetime {
      text-align: right;
      font-size: 0.9rem;
      color: #666;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 3fr;
      gap: 20px;
    }
    
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 20px;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .card-title {
      font-size: 1.1rem;
      color: var(--dark);
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .card-title svg {
      margin-right: 8px;
      color: var(--primary);
    }
    
    .patient-info {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 15px;
    }
    
    .patient-info .label {
      font-weight: 500;
      color: #666;
    }
    
    .heart-rate-display {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px 0;
    }
    
    .heart-rate-value {
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--danger);
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .heart-rate-unit {
      font-size: 1.2rem;
      color: #666;
      margin-top: 5px;
    }
    
    .heart-icon {
      animation: pulse 1s infinite;
      margin-right: 10px;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }
    
    .chart-container {
      position: relative;
      height: 350px;
      margin-bottom: 20px;
    }
    
    .signal-quality-container {
      margin: 20px 0;
    }
    
    .progress-bar {
      height: 12px;
      background-color: #e1e1e1;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-fill {
      height: 100%;
      background-color: var(--primary);
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    
    .high-quality {
      background-color: var(--success);
    }
    
    .medium-quality {
      background-color: var(--warning);
    }
    
    .low-quality {
      background-color: var(--danger);
    }
    
    .alarm-card {
      transition: all 0.3s;
    }
    
    .alarm-active {
      background-color: rgba(231, 76, 60, 0.1);
      border-left: 4px solid var(--danger);
    }
    
    .alarm-msg {
      display: flex;
      align-items: center;
      font-weight: 500;
      color: #666;
      padding: 10px 0;
    }
    
    .alarm-msg svg {
      margin-right: 8px;
    }
    
    .alarm-active .alarm-msg {
      color: var(--danger);
      font-weight: 600;
    }

    .ecg-info {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin: 15px 0;
    }
    
    .ecg-stat {
      text-align: center;
      padding: 15px;
      border-radius: var(--border-radius);
      background-color: var(--light);
      margin-bottom: 10px;
      min-width: 120px;
      flex: 1;
      margin: 0 5px;
    }
    
    .ecg-label {
      font-size: 0.8rem;
      color: #666;
      font-weight: 500;
    }
    
    .ecg-value {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 5px;
    }
    
    .button-container {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }
    
    .btn svg {
      margin-right: 8px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: #2980b9;
    }
    
    .btn-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .btn-danger:hover:not(:disabled) {
      background-color: #c0392b;
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: #1a252f;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .connection-setup {
      padding: 15px;
      border-radius: var(--border-radius);
      background-color: var(--light);
      margin-bottom: 20px;
    }
    
    .setup-header {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--secondary);
    }
    
    .setup-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .form-group label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .form-control {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .sensor-help {
      font-size: 0.85rem;
      line-height: 1.5;
      color: #666;
      margin-top: 15px;
    }
    
    @media (max-width: 992px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .datetime {
        text-align: left;
      }
      
      .sensor-info {
        margin-left: 0;
        margin-top: 5px;
      }
      
      .ecg-info {
        flex-direction: column;
      }
      
      .ecg-stat {
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="dashboard-header">
      <div>
        <div class="dashboard-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"></path>
            <path d="M3.5 12h6l.5-1 2 4 .5-1h8"></path>
          </svg>
          AD8232 ECG Monitor
        </div>
        <div class="sensor-info">AD8232 Single-Lead Heart Rate Monitor</div>
      </div>
      <div class="status-indicator">
        <div id="status-dot" class="status-dot status-offline"></div>
        <span id="status-text">Not connected</span>
      </div>
      <div class="datetime">
        <div id="date">--/--/----</div>
        <div id="time">--:--:--</div>
      </div>
    </div>
    
    <div class="dashboard-grid">
      <div class="sidebar">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Subject Information
            </div>
          </div>
          <div class="patient-info">
            <div class="label">Name:</div>
            <div id="subject-name">John Doe</div>
            <div class="label">Age:</div>
            <div id="subject-age">45</div>
            <div class="label">ID:</div>
            <div id="subject-id">001</div>
            <div class="label">Notes:</div>
            <div id="subject-notes">None</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                <line x1="6" y1="6" x2="6.01" y2="6"></line>
                <line x1="6" y1="18" x2="6.01" y2="18"></line>
              </svg>
              Connection Setup
            </div>
          </div>
          <div class="connection-setup">
            <div class="setup-header">AD8232 Connection</div>
            <div class="setup-form">
              <div class="form-group">
                <label for="device-port">Data Source</label>
                <select id="device-port" class="form-control">
                  <option value="demo">Demo Mode (Simulated)</option>
                  <option value="usb">USB Serial Port</option>
                  <option value="bluetooth">Bluetooth</option>
                  <option value="api">API Endpoint</option>
                </select>
              </div>
              
              <div class="form-group" id="api-url-group" style="display: none;">
                <label for="api-url">API URL</label>
                <input type="text" id="api-url" class="form-control" placeholder="http://127.0.0.1:5000/ecg">
              </div>
              
              <div class="form-group" id="serial-port-group" style="display: none;">
                <label for="serial-port">Port</label>
                <select id="serial-port" class="form-control">
                  <option value="">Select a port</option>
                  <option value="COM3">COM3</option>
                  <option value="COM4">COM4</option>
                  <option value="/dev/ttyUSB0">/dev/ttyUSB0</option>
                  <option value="/dev/ttyACM0">/dev/ttyACM0</option>
                </select>
              </div>
              
              <div class="form-group" id="baud-rate-group" style="display: none;">
                <label for="baud-rate">Baud Rate</label>
                <select id="baud-rate" class="form-control">
                  <option value="9600">9600</option>
                  <option value="19200">19200</option>
                  <option value="38400">38400</option>
                  <option value="57600">57600</option>
                  <option value="115200" selected>115200</option>
                </select>
              </div>
            </div>
            
            <div class="sensor-help">
              <p>The AD8232 typically connects to Arduino or other microcontrollers. For real-time monitoring, ensure your device is streaming ECG data via Serial, Bluetooth, or a Web API.</p>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
              Signal Quality
            </div>
          </div>
          <div class="signal-quality-container">
            <div class="quality-header">
              <span>Lead Status: </span>
              <span id="lead-status">Not connected</span>
            </div>
            <div class="quality-header" style="margin-top: 10px;">
              <span>Signal Quality: </span>
              <span id="signal-quality">--</span> / 100
            </div>
            <div class="progress-bar">
              <div id="quality-bar" class="progress-fill" style="width: 0%;"></div>
            </div>
          </div>
        </div>
        
        <div id="alarm-card" class="card alarm-card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              Alert
            </div>
          </div>
          <p id="alarm-msg" class="alarm-msg">No alerts</p>
        </div>
      </div>
      
      <div class="main-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"></path>
              </svg>
              Heart Rate Monitor
            </div>
          </div>
          
          <div class="heart-rate-display">
            <div class="heart-rate-value">
              <svg class="heart-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#e74c3c" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"></path>
              </svg>
              <span id="heart-rate">--</span>
            </div>
            <div class="heart-rate-unit">Beats Per Minute</div>
          </div>
          
          <div class="ecg-info">
            <div class="ecg-stat">
              <div class="ecg-label">R-R Interval</div>
              <div class="ecg-value" id="rr-interval">--</div>
              <div class="ecg-label">ms</div>
            </div>
            <div class="ecg-stat">
              <div class="ecg-label">QRS Duration</div>
              <div class="ecg-value" id="qrs-duration">--</div>
              <div class="ecg-label">ms</div>
            </div>
            <div class="ecg-stat">
              <div class="ecg-label">P-R Interval</div>
              <div class="ecg-value" id="pr-interval">--</div>
              <div class="ecg-label">ms</div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              ECG Waveform
            </div>
          </div>
          <div class="chart-container">
            <canvas id="ecgChart"></canvas>
          </div>
          
          <div class="button-container">
            <button id="start-btn" class="btn btn-primary" onclick="startMonitoring()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              Start Monitoring
            </button>
            <button id="stop-btn" class="btn btn-danger" onclick="stopMonitoring()" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
              </svg>
              Stop
            </button>
            <button id="save-btn" class="btn btn-secondary" onclick="saveECGData()" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              Save Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize ECG chart with Chart.js
    const ctx = document.getElementById('ecgChart').getContext('2d');
    const ecgChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({ length: 500 }, (_, i) => i),
        datasets: [{
          label: 'ECG',
          data: Array(500).fill(512),
          borderColor: '#e74c3c',
          borderWidth: 1.5,
          tension: 0.2,
          pointRadius: 0,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 0
        },
        scales: {
          y: { 
            min: 0, 
            max: 1023,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              stepSize: 200
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              display: false
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          }
        }
      }
    });

    // Variables to control data fetching
    let monitoringInterval;
    let isMonitoring = false;
    let ecgBuffer = Array(500).fill(512);
    let dataHistory = [];
    let lastBpm = 75;
    let leadsConnected = false;
    let peakThreshold = 700;
    let lastPeaks = [];
    
    // Listen for changes to the data source dropdown
    document.getElementById('device-port').addEventListener('change', function() {
      const selectedValue = this.value;
      document.getElementById('api-url-group').style.display = selectedValue === 'api' ? 'block' : 'none';
      document.getElementById('serial-port-group').style.display = selectedValue === 'usb' ? 'block' : 'none';
      document.getElementById('baud-rate-group').style.display = selectedValue === 'usb' ? 'block' : 'none';
    });

    // Function to fetch/simulate ECG data and update the chart
    async function updateECGData() {
      try {
        // Get selected data source
        const dataSource = document.getElementById('device-port').value;
        let newData;
        
        if (dataSource === 'demo') {
          // Simulate ECG data
          newData = simulateAD8232Data();
        } else if (dataSource === 'api') {
          // Fetch from API endpoint
          const apiUrl = document.getElementById('api-url').value;
          const response = await fetch(apiUrl);
          const data = await response.json();
          newData = data.ecgData || [];
        } else {
          // For USB/Bluetooth - in a real implementation, this would use 
          // Web Serial API or Web Bluetooth API to get real data
          console.log("Note: Real device data acquisition not implemented in this demo");
          newData = simulateAD8232Data();
        }
        
        // Update our buffer with new data
        updateECGBuffer(newData);
        
        // Update chart
        ecgChart.data.datasets[0].data = ecgBuffer;
        ecgChart.update('quiet');
        
        // Analyze the ECG data
        analyzeECG();
        
        // Update signal quality
        updateSignalQuality();
        
      } catch (err) {
        console.error('Error updating ECG data:', err);
        
        // If there's an error, mark leads as disconnected
        if (leadsConnected) {
          leadsConnected = false;
          document.getElementById("lead-status").innerText = "Disconnected";
          document.getElementById("alarm-card").classList.add("alarm-active");
          document.getElementById("alarm-msg").innerHTML = "Error: Check electrode connection";
        }
      }
    }
    
    // Function to update ECG buffer with new data
    function updateECGBuffer(newData) {
      // For simulated/demo data or API data that returns an array
      if (Array.isArray(newData)) {
        // Remove the oldest data points and add the new ones
        ecgBuffer.splice(0, newData.length);
        ecgBuffer = ecgBuffer.concat(newData);
      } 
      // For single data point (typical for real-time serial)
      else if (!isNaN(newData)) {
        ecgBuffer.shift();
        ecgBuffer.push(newData);
      }
      
      // Save to history for analysis
      dataHistory = dataHistory.concat(Array.isArray(newData) ? newData : [newData]);
      if (dataHistory.length > 2000) {
        dataHistory = dataHistory.slice(dataHistory.length - 2000);
      }
    }

    // Function to simulate AD8232 data with a complete ECG waveform pattern
function simulateAD8232Data() {
  const newDataPoints = [];
  const cycleLength = 200; // at 500Hz sampling, 200 samples = 0.4s (150 BPM)
  
  // Add variability to make it more realistic
  const variability = Math.random() * 20 - 10;
  const baselineDrift = Math.sin(Date.now() / 10000) * 50;
  
  for (let i = 0; i < 10; i++) {
    const position = (ecgBuffer.length + i) % cycleLength;
    let value = 512 + baselineDrift; // Baseline with drift
    
    // P-wave (atrial depolarization)
    if (position < 20) {
      const pWavePosition = position;
      const pWaveAmplitude = 40 + variability * 0.5;
      if (pWavePosition < 20) {
        value += pWaveAmplitude * Math.sin((pWavePosition / 20) * Math.PI);
      }
    } 
    // PR segment (delay at AV node)
    else if (position >= 20 && position < 50) {
      value += 0; // Flat PR segment
    }
    // QRS complex (ventricular depolarization)
    else if (position >= 50 && position < 70) {
      const qrsPosition = position - 50;
      
      if (qrsPosition < 5) {
        // Q wave
        value -= (100 + variability) * (qrsPosition / 5);
      } else if (qrsPosition >= 5 && qrsPosition < 10) {
        // R wave upstroke
        value += (400 + variability * 2) * ((qrsPosition - 5) / 5);
      } else if (qrsPosition >= 10 && qrsPosition < 15) {
        // R wave downstroke
        value += (400 + variability * 2) * (1 - (qrsPosition - 10) / 5);
      } else if (qrsPosition >= 15 && qrsPosition < 20) {
        // S wave
        value -= (150 + variability) * (1 - (qrsPosition - 15) / 5);
      }
    }
    // ST segment
    else if (position >= 70 && position < 100) {
      value += 0; // Flat ST segment
    }
    // T wave (ventricular repolarization)
    else if (position >= 100 && position < 150) {
      const tWavePosition = position - 100;
      const tWaveWidth = 50;
      const tWaveAmplitude = 100 + variability;
      value += tWaveAmplitude * Math.sin((tWavePosition / tWaveWidth) * Math.PI);
    }
    
    // Add noise
    value += Math.random() * 20 - 10;
    
    // Simulate lead disconnect occasionally
    if (Math.random() < 0.001) {
      value = Math.random() * 1023;
    }
    
    newDataPoints.push(Math.round(Math.max(0, Math.min(1023, value))));
  }
  
  return newDataPoints;
}

// Function to start ECG monitoring
function startMonitoring() {
  if (isMonitoring) return;
  
  // Update UI
  document.getElementById('start-btn').disabled = true;
  document.getElementById('stop-btn').disabled = false;
  document.getElementById('save-btn').disabled = false;
  
  document.getElementById('status-dot').classList.remove('status-offline');
  document.getElementById('status-dot').classList.add('status-online');
  document.getElementById('status-text').innerText = 'Connected';
  
  // Update time
  updateDateTime();
  
  // Reset data structures
  ecgBuffer = Array(500).fill(512);
  dataHistory = [];
  
  // Set monitoring status
  isMonitoring = true;
  
  // Start monitoring interval (updating every 50ms for realistic timing)
  monitoringInterval = setInterval(updateECGData, 50);
}

// Function to stop ECG monitoring
function stopMonitoring() {
  if (!isMonitoring) return;
  
  // Clear interval
  clearInterval(monitoringInterval);
  
  // Update UI
  document.getElementById('start-btn').disabled = false;
  document.getElementById('stop-btn').disabled = true;
  
  document.getElementById('status-dot').classList.remove('status-online');
  document.getElementById('status-dot').classList.add('status-offline');
  document.getElementById('status-text').innerText = 'Stopped';
  
  // Set monitoring status
  isMonitoring = false;
}

// Function to save ECG data
function saveECGData() {
  // Create a CSV from the history data
  const csvContent = "data:text/csv;charset=utf-8," + 
    dataHistory.join("\n");
  
  // Create a download link and trigger it
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  
  // Generate filename with timestamp
  const now = new Date();
  const timestamp = now.toISOString().replace(/[:.]/g, "-");
  const filename = `ECG_${document.getElementById('subject-id').innerText}_${timestamp}.csv`;
  
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", filename);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Function to analyze ECG data
function analyzeECG() {
  // Only analyze if we have enough data
  if (dataHistory.length < 500) return;
  
  // Look at recent data
  const recentData = dataHistory.slice(-500);
  
  // Identify R-peaks (simplified algorithm)
  const peaks = [];
  for (let i = 10; i < recentData.length - 10; i++) {
    if (recentData[i] > peakThreshold && 
        recentData[i] > recentData[i-1] && 
        recentData[i] > recentData[i+1] &&
        recentData[i] > recentData[i-10] &&
        recentData[i] > recentData[i+10]) {
      peaks.push(i);
    }
  }
  
  // Calculate heart rate from R-R intervals
  if (peaks.length >= 2) {
    const rrIntervals = [];
    for (let i = 1; i < peaks.length; i++) {
      rrIntervals.push(peaks[i] - peaks[i-1]);
    }
    
    // Calculate average R-R interval in samples
    const avgRRSamples = rrIntervals.reduce((a, b) => a + b, 0) / rrIntervals.length;
    
    // Convert to milliseconds (assuming 500Hz sampling rate => 2ms per sample)
    const rrIntervalMs = Math.round(avgRRSamples * 2);
    
    // Calculate BPM from R-R interval
    const bpm = Math.round(60000 / rrIntervalMs);
    
    // Update UI if the value is reasonable
    if (bpm >= 40 && bpm <= 200) {
      lastBpm = bpm;
      document.getElementById('heart-rate').innerText = bpm;
      document.getElementById('rr-interval').innerText = rrIntervalMs;
      
      // Simulate QRS duration and PR interval based on R-R
      const qrsDuration = Math.round(80 + Math.random() * 20);
      const prInterval = Math.round(160 + Math.random() * 40);
      
      document.getElementById('qrs-duration').innerText = qrsDuration;
      document.getElementById('pr-interval').innerText = prInterval;
      
      // Check for tachycardia or bradycardia
      if (bpm > 100) {
        document.getElementById("alarm-card").classList.add("alarm-active");
        document.getElementById("alarm-msg").innerHTML = 
          '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> ' +
          'Tachycardia detected';
      } else if (bpm < 60) {
        document.getElementById("alarm-card").classList.add("alarm-active");
        document.getElementById("alarm-msg").innerHTML = 
          '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> ' +
          'Bradycardia detected';
      } else {
        document.getElementById("alarm-card").classList.remove("alarm-active");
        document.getElementById("alarm-msg").innerText = "No alerts";
      }
    }
    
    // Store last peaks for signal quality assessment
    lastPeaks = peaks;
  } else if (peaks.length === 0 && isMonitoring) {
    // No peaks found, could be flat line or disconnect
    document.getElementById("alarm-card").classList.add("alarm-active");
    document.getElementById("alarm-msg").innerHTML = 
      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> ' +
      'No signal detected';
  }
}

// Function to update signal quality
function updateSignalQuality() {
  // Calculate signal quality based on:
  // 1. Signal variance (too low = flatline, too high = noise)
  // 2. Regularity of detected peaks
  
  // Only calculate if we have enough data
  if (dataHistory.length < 200 || !isMonitoring) {
    document.getElementById('lead-status').innerText = "Insufficient data";
    document.getElementById('signal-quality').innerText = "--";
    document.getElementById('quality-bar').style.width = "0%";
    document.getElementById('quality-bar').className = "progress-fill";
    return;
  }
  
  // Get most recent data
  const recentData = dataHistory.slice(-200);
  
  // Calculate variance
  const mean = recentData.reduce((a, b) => a + b, 0) / recentData.length;
  const variance = recentData.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / recentData.length;
  
  // Calculate peak regularity if we have peaks
  let peakRegularity = 100;
  if (lastPeaks.length >= 4) {
    const intervals = [];
    for (let i = 1; i < lastPeaks.length; i++) {
      intervals.push(lastPeaks[i] - lastPeaks[i-1]);
    }
    
    const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
    const intervalVariance = intervals.reduce((a, b) => a + Math.pow(b - avgInterval, 2), 0) / intervals.length;
    
    // Calculate regularity (100 = perfect, 0 = chaotic)
    peakRegularity = 100 - Math.min(100, Math.sqrt(intervalVariance) / avgInterval * 100);
  }
  
  // Simplified signal quality assessment
  // Ideal variance range: 10000-30000 for AD8232 with 10-bit ADC
  let varianceScore = 100;
  if (variance < 5000) {
    varianceScore = variance / 50; // Flatline or very weak signal
  } else if (variance > 50000) {
    varianceScore = Math.max(0, 100 - (variance - 50000) / 1000); // Too noisy
  }
  
  // Calculate final quality score
  const quality = Math.min(100, Math.round((varianceScore * 0.6) + (peakRegularity * 0.4)));
  
  // Update UI
  document.getElementById('signal-quality').innerText = quality;
  document.getElementById('quality-bar').style.width = quality + "%";
  
  // Set quality class
  if (quality >= 70) {
    document.getElementById('quality-bar').className = "progress-fill high-quality";
    document.getElementById('lead-status').innerText = "Connected - Good";
    leadsConnected = true;
  } else if (quality >= 40) {
    document.getElementById('quality-bar').className = "progress-fill medium-quality";
    document.getElementById('lead-status').innerText = "Connected - Fair";
    leadsConnected = true;
  } else {
    document.getElementById('quality-bar').className = "progress-fill low-quality";
    document.getElementById('lead-status').innerText = "Poor signal quality";
    leadsConnected = false;
  }
}

// Function to update date and time
function updateDateTime() {
  const now = new Date();
  
  // Format date: DD/MM/YYYY
  const date = now.toLocaleDateString();
  
  // Format time: HH:MM:SS
  const time = now.toLocaleTimeString();
  
  // Update the DOM
  document.getElementById('date').innerText = date;
  document.getElementById('time').innerText = time;
}

// Initialize date and time on load
document.addEventListener('DOMContentLoaded', function() {
  updateDateTime();
  
  // Set up interval to update date/time every second
  setInterval(updateDateTime, 1000);
});
